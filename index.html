<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
        }
        
        body {
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .app-header {
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 25px;
            position: relative;
        }
        
        .app-header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-header p {
            opacity: 0.9;
            max-width: 700px;
            margin: 8px 0 0;
            font-size: 0.95rem;
        }
        
        .app-header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
        }
        
        .app-body {
            padding: 20px;
        }
        
        .file-upload-container {
            background: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px dashed #d0d0d0;
        }
        
        .nav-tabs .nav-link {
            font-weight: 600;
            color: #555;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background: transparent;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-pane {
            padding-top: 15px;
        }
        
        .filter-section {
            background: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .filters-row {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        .dropdown-checkbox {
            display: inline-block;
            position: relative;
            margin-right: 0;
            margin-bottom: 5px;
            min-width: 140px;
            max-width: 200px;
            vertical-align: top;
        }
        
        .dropdown-checkbox .dropdown-toggle {
            cursor: pointer;
            width: 100%;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            background: white;
            border: 1px solid #ddd;
            padding: 7px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dropdown-checkbox .dropdown-toggle::after {
            content: "▼";
            font-size: 5px;
            margin-left: 5px;
        }
        
        .dropdown-checkbox .dropdown-menu {
            display: none;
            position: fixed;
            min-width: 200px;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            padding: 10px;
            border-radius: 6px;
        }
        
        .dropdown-checkbox.show .dropdown-menu {
            display: block;
        }
        
        .dropdown-checkbox label {
            display: block;
            font-weight: normal;
            margin-bottom: 4px;
            padding: 4px 6px;
            border-radius: 3px;
            transition: background 0.2s;
            font-size: 0.85rem;
        }
        
        .dropdown-checkbox label:hover {
            background: #f0f5ff;
        }
        
        .highlight {
            background-color: #fff3cd !important;
            font-weight: bold;
        }
        
        .badge-filter {
            margin-right: 6px;
            margin-bottom: 6px;
            padding: 5px 10px;
            font-weight: normal;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
        }
        
        .table-container {
            overflow: auto;
            max-height: 500px;
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .table-container.frozen-header thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .table-container.frozen-first-col td:first-child,
        .table-container.frozen-first-col th:first-child {
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 5;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }
        
        .table-container.frozen-header.frozen-first-col th:first-child {
            z-index: 15;
        }
        
        .table-container table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        
        .table-container table th {
            white-space: nowrap;
            background: #f8f9fa;
            padding: 8px 12px;
        }
        
        .table-container table td {
            padding: 6px 10px;
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .btn-group-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .frozen-controls {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .frozen-controls label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .numeric-filter-card {
            background: #f0f7ff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .pivot-table-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
            padding: 12px;
            text-align: center;
            border-left: 3px solid var(--accent-color);
            height: 100%;
        }
        
        .stat-card h5 {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 6px;
        }
        
        .stat-card .value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .footer-credit {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 0.85rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .pagination-controls {
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tab-pane-content {
            padding: 10px 0;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:after {
            content: " ⇅";
            font-size: 0.7em;
            color: #888;
        }
        
        .sortable.sorted-asc:after {
            content: " ↑";
        }
        
        .sortable.sorted-desc:after {
            content: " ↓";
        }
        
        .stats-accordion .accordion-button {
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }
        
        .stats-accordion .accordion-body {
            padding: 1rem;
        }
        
        .stats-table {
            font-size: 0.85rem;
        }
        
        .stats-table th {
            background-color: #f8f9fa;
        }
        
        .stats-table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .stats-table .stat-label {
            font-weight: 600;
            width: 50%;
        }
        
        .page-jump {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        
        .page-jump input {
            width: 70px;
            text-align: center;
        }

        /* Novos estilos para acordeões */
        .accordion-item .accordion-button {
            padding: 0.8rem 1.25rem;
        }
        
        .accordion-icon {
            width: 24px;
            text-align: center;
            margin-right: 10px;
        }
        
        .column-type-badge {
            font-size: 0.75rem;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        .distribution-bar {
            background-color: #4361ee;
            margin: 0 1px;
            position: relative;
            transition: height 0.3s ease;
        }
        
        .distribution-bar:hover {
            background-color: #3a56e0;
            cursor: pointer;
        }
        
        /* Melhorias na apresentação de tipos */
        .badge-numeric {
            background-color: #4361ee !important;
        }
        .badge-currency {
            background-color: #4cc9f0 !important;
        }
        .badge-date {
            background-color: #f72585 !important;
        }
        .badge-text {
            background-color: #6c757d !important;
        }
        
        /* Estilos para a aba Sobre */
        .about-content {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .about-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .about-content ul {
            padding-left: 20px;
        }
        
        .about-content li {
            margin-bottom: 8px;
        }
        
        .security-badge {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 3px solid var(--accent-color);
        }
        
        .feature-card i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-group-actions {
                width: 100%;
                justify-content: center;
            }
            
            .frozen-controls {
                flex-wrap: wrap;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .page-jump {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fas fa-table"></i>Data Explorer</h1>
            <p>Análise e exploração de dados - Importe arquivos CSV ou Excel diretamente no navegador</p>
        </header>
        
        <div class="app-body">
            <div class="file-upload-container">
                <div class="mb-3">
                    <label for="fileInput" class="form-label">
                        <i class="fas fa-file-import me-2"></i> Carregar arquivo (CSV ou Excel)
                    </label>
                    <input class="form-control" type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                </div>
            </div>
            
            <ul class="nav nav-tabs" id="mainTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-pane" type="button" role="tab" aria-controls="table-pane" aria-selected="true">
                        <i class="fas fa-table me-2"></i>Tabela
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="duplicates-tab" data-bs-toggle="tab" data-bs-target="#duplicates-pane" type="button" role="tab" aria-controls="duplicates-pane" aria-selected="false">
                        <i class="fas fa-clone me-2"></i>Duplicados
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pivot-tab" data-bs-toggle="tab" data-bs-target="#pivot-pane" type="button" role="tab" aria-controls="pivot-pane">
                        <i class="fas fa-sync-alt me-2"></i>Tabela Dinâmica
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button" role="tab" aria-controls="stats-pane">
                        <i class="fas fa-chart-line me-2"></i>Estatísticas
                    </button>
                </li>
                <!-- Nova aba Sobre -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about-pane" type="button" role="tab" aria-controls="about-pane">
                        <i class="fas fa-info-circle me-2"></i>Sobre
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="mainTabContent">
                <!-- Aba Tabela -->
                <div class="tab-pane fade show active" id="table-pane" role="tabpanel" aria-labelledby="table-tab">
                    <div class="filter-section">
                        <div class="controls-row">
                            <div>
                                <input class="form-control form-control-sm" id="globalSearch" placeholder="Pesquisar em todas as colunas..." type="text" style="max-width: 300px;">
                            </div>
                            <div class="btn-group-actions">
                                <button class="btn btn-sm btn-success btn-action" id="exportCsvBtn">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-sm btn-success btn-action" id="exportExcelBtn">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" id="clearFiltersBtn">
                                    <i class="fas fa-filter-circle-xmark"></i> Limpar
                                </button>
                            </div>
                        </div>
                        
                        <div class="frozen-controls">
                            <div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="freezeHeaderToggle" checked>
                                    <label class="form-check-label" for="freezeHeaderToggle">Cabeçalho Fixo</label>
                                </div>
                            </div>
                            <div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="freezeFirstColToggle" checked>
                                    <label class="form-check-label" for="freezeFirstColToggle">1ª Coluna Fixa</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="numeric-filter-card">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <select id="numericColumnSelect" class="form-select form-select-sm">
                                        <option value="">Selecione coluna</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select id="numericOperatorSelect" class="form-select form-select-sm">
                                        <option value=">">Maior que</option>
                                        <option value="<">Menor que</option>
                                        <option value="=">Igual a</option>
                                        <option value="between">Entre</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" id="numericValueInput" class="form-control form-control-sm" placeholder="Valor">
                                </div>
                                <div class="col-md-2" id="numericValueInput2Container" style="display:none;">
                                    <input type="number" id="numericValueInput2" class="form-control form-control-sm" placeholder="e">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-primary w-100" id="applyNumericFilter">
                                        <i class="fas fa-plus me-1"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                            <div id="activeNumericFilters" class="mt-2"></div>
                        </div>
                        
                        <div class="filters-row" id="filtersRow"></div>
                        <div id="activeFilters" class="d-flex flex-wrap mt-2"></div>
                    </div>
                    
                    <div class="table-container frozen-header frozen-first-col" id="tableContainer">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead>
                                <tr id="tableHeader"></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div id="paginationControls" class="pagination-controls"></div>
                        <div class="text-muted small">
                            <i class="fas fa-database me-1"></i>
                            Total: <span id="totalRecords">0</span> registros
                        </div>
                    </div>
                </div>
                
                <!-- Aba Duplicados -->
                <div class="tab-pane fade" id="duplicates-pane" role="tabpanel" aria-labelledby="duplicates-tab">
                    <div class="filter-section">
                        <h5 class="mb-3"><i class="fas fa-clone me-2"></i> Valores Duplicados por Coluna</h5>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <label class="small">Selecione a coluna:&nbsp;
                                        <select id='dupColSelect' class='form-select form-select-sm'>
                                            <option value='_ALL_'>Todas as colunas</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-sm btn-success" id="exportDuplicatesBtn">
                                    <i class="fas fa-file-export me-1"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div id="duplicatesTableDiv" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Aba Tabela Dinâmica -->
                <div class="tab-pane fade" id="pivot-pane" role="tabpanel" aria-labelledby="pivot-tab">
                    <div class="filter-section">
                        <div class="controls-row">
                            <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i> Tabela Dinâmica</h5>
                            <div class="btn-group-actions">
                                <button class="btn btn-sm btn-success" id="exportPivotCsvBtn">
                                    <i class="fas fa-file-csv me-1"></i> CSV
                                </button>
                                <button class="btn btn-sm btn-success" id="exportPivotExcelBtn">
                                    <i class="fas fa-file-excel me-1"></i> Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="frozen-controls">
                            <div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="freezePivotHeaderToggle" checked>
                                    <label class="form-check-label" for="freezePivotHeaderToggle">Cabeçalho Fixo</label>
                                </div>
                            </div>
                            <div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="freezePivotFirstColToggle" checked>
                                    <label class="form-check-label" for="freezePivotFirstColToggle">1ª Coluna Fixa</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mt-2">
                            <div class="col-md-3">
                                <label class="small">Linhas:</label>
                                <select class="form-select form-select-sm" id="pivotRowSelect"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="small">Colunas (opcional):</label>
                                <select class="form-select form-select-sm" id="pivotColSelect">
                                    <option value="">Nenhuma</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="small">Valores:</label>
                                <select class="form-select form-select-sm" id="pivotValueSelect"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="small">Agregação:</label>
                                <select class="form-select form-select-sm" id="pivotAggSelect">
                                    <option value="sum">soma</option>
                                    <option value="mean">média</option>
                                    <option value="count">contagem</option>
                                    <option value="max">máximo</option>
                                    <option value="min">mínimo</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm mt-3" id="generatePivotBtn">
                            <i class="fas fa-calculator me-1"></i> Gerar Tabela
                        </button>
                        
                        <div class="pivot-table-container frozen-header frozen-first-col mt-3" id="pivotTableContainer">
                            <table class="table table-bordered table-sm" id="pivotTable">
                                <thead id="pivotHeader"></thead>
                                <tbody id="pivotBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Aba Estatísticas -->
                <div class="tab-pane fade" id="stats-pane" role="tabpanel" aria-labelledby="stats-tab">
                    <div class="filter-section">
                        <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i> Análise Estatística Detalhada</h5>
                        <div class="stats-grid mb-4">
                            <div class="stat-card">
                                <h5><i class="fas fa-database me-2"></i> Total de Registros</h5>
                                <div class="value" id="statTotalRecords">0</div>
                            </div>
                            <div class="stat-card">
                                <h5><i class="fas fa-filter me-2"></i> Registros Filtrados</h5>
                                <div class="value" id="statFilteredRecords">0</div>
                            </div>
                            <div class="stat-card">
                                <h5><i class="fas fa-columns me-2"></i> Total de Colunas</h5>
                                <div class="value" id="statTotalColumns">0</div>
                            </div>
                            <div class="stat-card">
                                <h5><i class="fas fa-percentage me-2"></i> Preenchimento</h5>
                                <div class="value" id="statFillRate">0%</div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Estatísticas por Coluna</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" id="expandAllStats">
                                    <i class="fas fa-expand me-1"></i> Expandir Tudo
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="collapseAllStats">
                                    <i class="fas fa-compress me-1"></i> Recolher Tudo
                                </button>
                            </div>
                        </div>
                        
                        <div class="accordion stats-accordion" id="columnStatsAccordion">
                            <!-- Acordeões serão gerados dinamicamente para todas as colunas -->
                        </div>
                    </div>
                </div>
                
                <!-- Nova aba Sobre -->
                <div class="tab-pane fade" id="about-pane" role="tabpanel" aria-labelledby="about-tab">
                    <div class="filter-section">
                        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i> Sobre o Data Explorer</h5>
                        <div class="about-content">
                            <p>O Data Explorer é uma ferramenta de análise de dados que funciona inteiramente no seu navegador. Você pode carregar arquivos CSV ou Excel para explorar e analisar seus dados sem enviar informações para servidores externos.</p>
                            
                            <h6>Como Funciona</h6>
                            <ol>
                                <li><strong>Carregue seu arquivo</strong>: Use o botão "Carregar arquivo" para selecionar um arquivo CSV ou Excel do seu computador.</li>
                                <li><strong>Explore os dados</strong>: Na aba Tabela, você pode visualizar seus dados, aplicar filtros e ordenar informações.</li>
                                <li><strong>Analise duplicatas</strong>: Use a aba Duplicados para identificar valores repetidos em suas colunas.</li>
                                <li><strong>Crie tabelas dinâmicas</strong>: Na aba Tabela Dinâmica, você pode agrupar e resumir seus dados de várias formas.</li>
                                <li><strong>Veja estatísticas</strong>: A aba Estatísticas fornece análises detalhadas sobre cada coluna do seu conjunto de dados.</li>
                            </ol>
                            
                            <div class="feature-list">
                                <div class="feature-card">
                                    <i class="fas fa-lock"></i>
                                    <h6>Segurança</h6>
                                    <p>Todos os dados são processados localmente em seu navegador. Seus arquivos nunca são enviados para servidores externos.</p>
                                </div>
                                <div class="feature-card">
                                    <i class="fas fa-bolt"></i>
                                    <h6>Performance</h6>
                                    <p>Otimizado para lidar com conjuntos de dados de tamanho médio (até 100.000 linhas) com eficiência.</p>
                                </div>
                                <div class="feature-card">
                                    <i class="fas fa-download"></i>
                                    <h6>Exportação</h6>
                                    <p>Exporte dados filtrados, tabelas dinâmicas e relatórios de duplicatas em CSV ou Excel.</p>
                                </div>
                                <div class="feature-card">
                                    <i class="fas fa-sliders-h"></i>
                                    <h6>Filtros Avançados</h6>
                                    <p>Filtre por valores específicos, faixas numéricas e buscas globais com interface intuitiva.</p>
                                </div>
                            </div>
                            
                            <h6>Limitações</h6>
                            <ul>
                                <li>A ferramenta funciona inteiramente no navegador, portanto o desempenho depende do seu dispositivo;</li>
                                <li>Arquivos muito grandes (acima de 100.000 linhas) podem ter desempenho reduzido;</li>
                                <li>Colunas em branco podem afetar o comportamento (seleção) dos filtros;</li>
                                <li>Formatos de data e hora complexos podem não ser interpretados corretamente;</li>
                                <li>Arquivos Excel com múltiplas planilhas processarão apenas a primeira planilha.</li>
                            </ul>
                            
                            <div class="security-badge">
                                <i class="fas fa-shield-alt me-2"></i> 
                                <strong>Segurança dos dados</strong>: 
                                Todos os processamentos ocorrem localmente no seu navegador. 
                                Seus arquivos <u>nunca são enviados</u> para servidores externos e são mantidos apenas durante sua sessão no navegador.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-credit">
                <p>Data Explorer v2.0 🦎 wendell.enter@mail.com</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        // Variáveis globais
        let allData = [];
        let columns = [];
        let filteredData = [];
        let rowsPerPage = 100;
        let currentPage = 1;
        let sortCol = null;
        let sortDir = null;
        let allDuplicates = {};
        let numericFilters = [];

        // Fechar dropdowns ao clicar fora
        document.addEventListener('click', function(event) {
            const dropdowns = document.querySelectorAll('.dropdown-checkbox');
            dropdowns.forEach(dropdown => {
                if (!dropdown.contains(event.target)) {
                    dropdown.classList.remove('show');
                    const menu = dropdown.querySelector('.dropdown-menu');
                    if (menu) menu.style.display = 'none';
                }
            });
        });

        // Função para carregar o arquivo
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const extension = file.name.split('.').pop().toLowerCase();
            if (extension === 'csv') {
                parseCSV(file);
            } else if (extension === 'xlsx' || extension === 'xls') {
                parseExcel(file);
            } else {
                alert('Formato de arquivo não suportado. Use CSV ou Excel.');
            }
        });

        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length) {
                        console.error('Erros no parse:', results.errors);
                        alert('Ocorreram erros ao processar o arquivo CSV.');
                    }
                    processData(results.data, results.meta.fields);
                }
            });
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length < 1) {
                    alert('A planilha está vazia.');
                    return;
                }

                // A primeira linha é o cabeçalho
                const headers = jsonData[0];
                const rows = jsonData.slice(1);
                const dataObjects = rows.map(row => {
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = row[i];
                    });
                    return obj;
                });

                processData(dataObjects, headers);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data, headers) {
            allData = data.filter(row => {
                return headers.some(header => row[header] !== undefined);
            });
            columns = headers;

            // Calcular duplicados
            calculateDuplicates();

            // Inicializar a interface
            initTable();
            initFilters();
            initDuplicates();
            initPivotControls();
            initNumericFilters();
            generateStats();

            // Ativar a aba de tabela
            document.getElementById('table-tab').click();
        }

        function calculateDuplicates() {
            allDuplicates = {};
            columns.forEach(col => {
                const counts = {};
                allData.forEach(row => {
                    const val = row[col];
                    if (val !== undefined && val !== null) {
                        const strVal = String(val);
                        counts[strVal] = (counts[strVal] || 0) + 1;
                    }
                });
                
                const duplicates = [];
                for (const [val, count] of Object.entries(counts)) {
                    if (count > 1) {
                        duplicates.push([val, count]);
                    }
                }
                
                if (duplicates.length > 0) {
                    allDuplicates[col] = duplicates;
                }
            });
        }

        function initTable() {
            // Limpar a tabela
            document.getElementById('tableHeader').innerHTML = '';
            document.getElementById('tableBody').innerHTML = '';

            // Adicionar cabeçalhos
            columns.forEach((col, i) => {
                const th = document.createElement('th');
                th.className = 'sortable';
                th.setAttribute('data-col', i);
                th.textContent = col;
                document.getElementById('tableHeader').appendChild(th);
            });

            // Renderizar os dados
            filteredData = [...allData];
            renderTable(filteredData);

            // Adicionar event listeners para ordenação
            document.querySelectorAll('#tableHeader th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const colIdx = parseInt(this.getAttribute('data-col'));
                    if (sortCol === colIdx) {
                        sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortCol = colIdx;
                        sortDir = 'asc';
                    }
                    // Atualizar classes de ordenação
                    document.querySelectorAll('#tableHeader th.sortable').forEach(h => {
                        h.classList.remove('sorted-asc', 'sorted-desc');
                    });
                    this.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    renderTable(filteredData);
                });
            });

            // Atualizar controles de congelamento
            document.getElementById('freezeHeaderToggle').addEventListener('change', updateFreezeSettings);
            document.getElementById('freezeFirstColToggle').addEventListener('change', updateFreezeSettings);
            document.getElementById('freezePivotHeaderToggle').addEventListener('change', updatePivotFreezeSettings);
            document.getElementById('freezePivotFirstColToggle').addEventListener('change', updatePivotFreezeSettings);
            
            // Configurar exportação
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportPivotCsvBtn').addEventListener('click', exportPivotToCsv);
            document.getElementById('exportPivotExcelBtn').addEventListener('click', exportPivotToExcel);
            document.getElementById('exportDuplicatesBtn').addEventListener('click', exportDuplicates);
            
            // Correção para os filtros
            document.getElementById('globalSearch').addEventListener('input', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        }

        function updateFreezeSettings() {
            const container = document.getElementById('tableContainer');
            const freezeHeader = document.getElementById('freezeHeaderToggle').checked;
            const freezeFirstCol = document.getElementById('freezeFirstColToggle').checked;
            
            container.className = 'table-container';
            if (freezeHeader) container.classList.add('frozen-header');
            if (freezeFirstCol) container.classList.add('frozen-first-col');
        }

        function updatePivotFreezeSettings() {
            const container = document.getElementById('pivotTableContainer');
            const freezeHeader = document.getElementById('freezePivotHeaderToggle').checked;
            const freezeFirstCol = document.getElementById('freezePivotFirstColToggle').checked;
            
            container.className = 'pivot-table-container';
            if (freezeHeader) container.classList.add('frozen-header');
            if (freezeFirstCol) container.classList.add('frozen-first-col');
        }

        function initFilters() {
            const filtersRow = document.getElementById('filtersRow');
            filtersRow.innerHTML = '';

            columns.forEach((col, i) => {
                const dropdownDiv = document.createElement('div');
                dropdownDiv.className = 'dropdown-checkbox';
                dropdownDiv.innerHTML = `
                    <span class="dropdown-toggle btn btn-light btn-sm border" onclick="toggleDropdown(${i})">${col}</span>
                    <div class="dropdown-menu" id="menu_${i}">
                        <input type="text" placeholder="Buscar..." class="form-control form-control-sm mb-2" onkeyup="filterCheckboxes(${i}, this.value)" onmousedown="event.stopPropagation()">
                        <div class="dropdown-scroll" style="max-height:220px;overflow-y:auto;padding-right:3px;">
                            <label>
                                <input type="checkbox" class="filter-checkbox" data-col="${i}" value="__ALL__" checked onchange="allCheck(${i})"> <b>Todos</b>
                            </label>
                        </div>
                    </div>
                `;
                filtersRow.appendChild(dropdownDiv);

                // Preencher opções do filtro
                const values = [...new Set(allData.map(row => row[col]))].filter(v => v != null);
                values.sort((a, b) => String(a).localeCompare(String(b)));
                const menu = document.getElementById(`menu_${i}`);
                const checksDiv = menu.querySelector('.dropdown-scroll');
                values.forEach(val => {
                    const label = document.createElement('label');
                    const strVal = String(val);
                    label.innerHTML = `<input type="checkbox" class="filter-checkbox" data-col="${i}" value="${strVal}"> ${strVal}`;
                    checksDiv.appendChild(label);
                });
            });

            // Evento de mudança nos checkboxes
            document.querySelectorAll('.filter-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.value !== "__ALL__") {
                        const menu = this.closest('.dropdown-menu');
                        const allCb = menu.querySelector('.filter-checkbox[value="__ALL__"]');
                        if (allCb) allCb.checked = false;
                    }
                    applyFilters();
                });
            });
        }

        function initDuplicates() {
            const dupColSelect = document.getElementById('dupColSelect');
            // Limpar e adicionar opções (exceto a primeira que é "Todas")
            dupColSelect.innerHTML = '<option value="_ALL_">Todas as colunas</option>';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                dupColSelect.appendChild(option);
            });
            dupColSelect.addEventListener('change', function() {
                renderDuplicatesTable(this.value);
            });
            renderDuplicatesTable('_ALL_');
        }

        function initPivotControls() {
            const rowSelect = document.getElementById('pivotRowSelect');
            const colSelect = document.getElementById('pivotColSelect');
            const valueSelect = document.getElementById('pivotValueSelect');

            // Limpar e preencher
            rowSelect.innerHTML = '';
            colSelect.innerHTML = '<option value="">Nenhuma</option>';
            valueSelect.innerHTML = '';

            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;

                rowSelect.appendChild(option.cloneNode(true));
                colSelect.appendChild(option.cloneNode(true));
                valueSelect.appendChild(option.cloneNode(true));
            });

            // Botão gerar pivot
            document.getElementById('generatePivotBtn').addEventListener('click', generatePivotTable);
        }

        function initNumericFilters() {
            const select = document.getElementById('numericColumnSelect');
            select.innerHTML = '<option value="">Selecione uma coluna</option>';
            
            columns.forEach(col => {
                // Verificar se a coluna é numérica
                const sampleValue = allData.find(d => d[col] !== undefined && d[col] !== null)?.[col];
                if (typeof sampleValue === 'number') {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    select.appendChild(option);
                }
            });
            
            // Mostrar/ocultar segundo campo para "Entre"
            document.getElementById('numericOperatorSelect').addEventListener('change', function() {
                const container = document.getElementById('numericValueInput2Container');
                container.style.display = this.value === 'between' ? 'block' : 'none';
            });
            
            // Aplicar filtro numérico
            document.getElementById('applyNumericFilter').addEventListener('click', applyNumericFilter);
        }

        // Funções globais acessíveis
        window.toggleDropdown = function(idx) {
            const menu = document.getElementById(`menu_${idx}`);
            const parent = menu.parentElement;
            const isOpen = parent.classList.contains('show');
            
            // Fechar todos os dropdowns
            document.querySelectorAll('.dropdown-checkbox').forEach(el => {
                el.classList.remove('show');
                const m = el.querySelector('.dropdown-menu');
                if (m) m.style.display = 'none';
            });
            
            if (!isOpen) {
                parent.classList.add('show');
                menu.style.display = 'block';
                const btn = parent.querySelector('.dropdown-toggle');
                const rect = btn.getBoundingClientRect();
                menu.style.top = (rect.bottom + window.scrollY) + 'px';
                menu.style.left = (rect.left + window.scrollX) + 'px';
                menu.style.width = rect.width + 'px';
                
                // Focar no campo de busca
                setTimeout(() => {
                    const input = menu.querySelector('input[type="text"]');
                    if (input) input.focus();
                }, 150);
            }
        };

        window.filterCheckboxes = function(idx, search) {
            const menu = document.getElementById(`menu_${idx}`);
            const labels = menu.querySelectorAll('.dropdown-scroll label');
            search = search.toLowerCase();
            
            labels.forEach((label, i) => {
                if (i === 0) return; // Pular o "Todos"
                const text = label.textContent.toLowerCase();
                if (text.includes(search)) {
                    label.style.display = '';
                } else {
                    label.style.display = 'none';
                }
            });
        };

        window.allCheck = function(idx) {
            const menu = document.getElementById(`menu_${idx}`);
            const allCb = menu.querySelector('.filter-checkbox[value="__ALL__"]');
            const checkboxes = menu.querySelectorAll('.filter-checkbox:not([value="__ALL__"])');
            
            if (allCb.checked) {
                checkboxes.forEach(cb => cb.checked = false);
            }
            applyFilters();
        };

        function applyFilters() {
            // Obter valores selecionados em cada filtro
            const filters = {};
            for (let i = 0; i < columns.length; i++) {
                const menu = document.getElementById(`menu_${i}`);
                if (!menu) continue;
                
                const checks = menu.querySelectorAll('.filter-checkbox:checked:not([value="__ALL__"])');
                const values = Array.from(checks).map(cb => cb.value);
                
                if (values.length > 0) {
                    filters[i] = values;
                }
            }
            
            // Obter termo de busca global
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            
            // Filtrar dados
            filteredData = allData.filter(row => {
                // Aplicar filtros de coluna
                for (const [colIdx, values] of Object.entries(filters)) {
                    const colName = columns[colIdx];
                    const rowValue = row[colName];
                    if (rowValue === undefined || rowValue === null) return false;
                    
                    const strValue = String(rowValue);
                    if (!values.includes(strValue)) {
                        return false;
                    }
                }
                
                // Aplicar filtros numéricos
                for (const filter of numericFilters) {
                    const rowValue = parseFloat(row[filter.column]);
                    if (isNaN(rowValue)) return false;
                    
                    switch(filter.operator) {
                        case '>': 
                            if (rowValue <= filter.value) return false;
                            break;
                        case '<': 
                            if (rowValue >= filter.value) return false;
                            break;
                        case '=': 
                            if (rowValue !== filter.value) return false;
                            break;
                        case 'between': 
                            if (rowValue < filter.value || rowValue > filter.value2) return false;
                            break;
                    }
                }
                
                // Aplicar busca global
                if (searchTerm) {
                    let found = false;
                    for (const col of columns) {
                        const value = row[col];
                        if (value !== undefined && value !== null) {
                            if (String(value).toLowerCase().includes(searchTerm)) {
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found) return false;
                }
                
                return true;
            });
            
            currentPage = 1;
            renderTable(filteredData);
            updateActiveFilters(filters);
            generateStats();
        }

        function applyNumericFilter() {
            const column = document.getElementById('numericColumnSelect').value;
            const operator = document.getElementById('numericOperatorSelect').value;
            const value = parseFloat(document.getElementById('numericValueInput').value);
            
            if (!column) {
                alert('Selecione uma coluna para aplicar o filtro');
                return;
            }
            
            if (isNaN(value)) {
                alert('Digite um valor válido');
                return;
            }
            
            const newFilter = {
                column: column,
                operator: operator,
                value: value
            };
            
            if (operator === 'between') {
                const value2 = parseFloat(document.getElementById('numericValueInput2').value);
                if (isNaN(value2)) {
                    alert('Digite o segundo valor para o intervalo');
                    return;
                }
                newFilter.value2 = value2;
            }
            
            // Verificar se o filtro já existe
            const exists = numericFilters.some(f => 
                f.column === column && 
                f.operator === operator && 
                f.value === value
            );
            
            if (!exists) {
                numericFilters.push(newFilter);
                renderNumericFilters();
                applyFilters();
            }
        }

        function renderNumericFilters() {
            const container = document.getElementById('activeNumericFilters');
            container.innerHTML = '';
            
            if (numericFilters.length === 0) return;
            
            let html = '<div class="d-flex align-items-center flex-wrap gap-2"><strong>Filtros numéricos ativos:</strong>';
            
            numericFilters.forEach((filter, index) => {
                let label = '';
                switch(filter.operator) {
                    case '>': label = `${filter.column} > ${filter.value}`; break;
                    case '<': label = `${filter.column} < ${filter.value}`; break;
                    case '=': label = `${filter.column} = ${filter.value}`; break;
                    case 'between': label = `${filter.value} ≤ ${filter.column} ≤ ${filter.value2}`; break;
                }
                
                html += `
                    <span class="badge bg-primary badge-filter">
                        ${label}
                        <a href="#" onclick="removeNumericFilter(${index}); return false;"><i class="fas fa-times"></i></a>
                    </span>
                `;
            });
            
            html += `<button class="btn btn-sm btn-danger" onclick="clearNumericFilters()">
                <i class="fas fa-trash me-1"></i> Limpar Tudo
            </button></div>`;
            
            container.innerHTML = html;
        }

        window.removeNumericFilter = function(index) {
            numericFilters.splice(index, 1);
            renderNumericFilters();
            applyFilters();
        };

        window.clearNumericFilters = function() {
            numericFilters = [];
            renderNumericFilters();
            applyFilters();
        };

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const start = (currentPage - 1) * rowsPerPage;
            const end = Math.min(start + rowsPerPage, data.length);
            const pageData = data.slice(start, end);
            
            // Dados ordenados se necessário
            let displayData = [...pageData];
            if (sortCol !== null) {
                displayData.sort((a, b) => {
                    const valA = a[columns[sortCol]];
                    const valB = b[columns[sortCol]];
                    
                    if (valA === valB) return 0;
                    if (valA === undefined || valA === null) return 1;
                    if (valB === undefined || valB === null) return -1;
                    
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    
                    return sortDir === 'asc' ? 
                        strA.localeCompare(strB) : 
                        strB.localeCompare(strA);
                });
            }
            
            // Preencher tabela
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = row[col];
                    td.textContent = value !== undefined && value !== null ? value : '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            // Atualizar controles de paginação
            updatePaginationControls(data.length);
            // Atualizar contagem de registros
            document.getElementById('totalRecords').textContent = data.length;
            // Destacar termos de busca
            highlightSearch();
        }

        function updatePaginationControls(totalRows) {
            const controls = document.getElementById('paginationControls');
            const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
            
            controls.innerHTML = `
                <button class="btn btn-sm btn-light" onclick="prevPage()" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="mx-2">Página ${currentPage} de ${totalPages}</span>
                <button class="btn btn-sm btn-light" onclick="nextPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Próxima <i class="fas fa-chevron-right"></i>
                </button>
                <div class="ms-2 d-inline-flex align-items-center">
                    <span class="me-2">Linhas:</span>
                    <select class="form-select form-select-sm" style="width: 80px;" id="rowsPerPageSelect">
                        <option value="50" ${rowsPerPage === 50 ? 'selected' : ''}>50</option>
                        <option value="100" ${rowsPerPage === 100 ? 'selected' : ''}>100</option>
                        <option value="200" ${rowsPerPage === 200 ? 'selected' : ''}>200</option>
                        <option value="500" ${rowsPerPage === 500 ? 'selected' : ''}>500</option>
                    </select>
                </div>
                <div class="page-jump">
                    <input type="number" min="1" max="${totalPages}" id="goToPageInput" class="form-control form-control-sm" style="width: 70px;" placeholder="Pág">
                    <button class="btn btn-sm btn-light" onclick="goToPage()">Ir</button>
                </div>
            `;
            
            // Evento para alterar número de linhas por página
            document.getElementById('rowsPerPageSelect').addEventListener('change', function() {
                rowsPerPage = parseInt(this.value);
                currentPage = 1;
                renderTable(filteredData);
            });
        }

        window.prevPage = function() {
            if (currentPage > 1) {
                currentPage--;
                renderTable(filteredData);
            }
        };

        window.nextPage = function(totalPages) {
            if (currentPage < totalPages) {
                currentPage++;
                renderTable(filteredData);
            }
        };

        window.goToPage = function() {
            const input = document.getElementById('goToPageInput');
            const page = parseInt(input.value);
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            
            if (isNaN(page)) {
                alert('Digite um número válido');
                return;
            }
            
            if (page < 1 || page > totalPages) {
                alert(`Página deve estar entre 1 e ${totalPages}`);
                return;
            }
            
            currentPage = page;
            renderTable(filteredData);
        };

        function updateActiveFilters(filters) {
            const activeFilters = document.getElementById('activeFilters');
            let html = '';
            
            for (const [colIdx, values] of Object.entries(filters)) {
                const colName = columns[colIdx];
                values.forEach(val => {
                    html += `
                        <span class="badge bg-info text-dark badge-filter">
                            <i class="fas fa-filter me-1"></i> ${colName}: ${val}
                            <a href="#" onclick="removeFilter(${colIdx}, '${val}'); return false;"><i class="fas fa-times"></i></a>
                        </span>
                    `;
                });
            }
            
            activeFilters.innerHTML = html;
        }

        window.removeFilter = function(colIdx, val) {
            const menu = document.getElementById(`menu_${colIdx}`);
            const checkboxes = menu.querySelectorAll('.filter-checkbox');
            
            checkboxes.forEach(cb => {
                if (cb.value === val) {
                    cb.checked = false;
                }
            });
            
            // Verificar se precisa marcar "Todos"
            const checked = menu.querySelectorAll('.filter-checkbox:checked:not([value="__ALL__"])');
            if (checked.length === 0) {
                const allCb = menu.querySelector('.filter-checkbox[value="__ALL__"]');
                if (allCb) allCb.checked = true;
            }
            
            applyFilters();
        };

        function clearFilters() {
            // Limpar todos os checkboxes
            document.querySelectorAll('.filter-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // Marcar "Todos" em cada dropdown
            for (let i = 0; i < columns.length; i++) {
                const menu = document.getElementById(`menu_${i}`);
                if (menu) {
                    const allCb = menu.querySelector('.filter-checkbox[value="__ALL__"]');
                    if (allCb) allCb.checked = true;
                }
            }
            
            // Limpar busca global
            document.getElementById('globalSearch').value = '';
            
            // Limpar filtros numéricos
            clearNumericFilters();
            
            applyFilters();
        }

        function highlightSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            if (!searchTerm) return;
            
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach(cell => {
                    const originalContent = cell.textContent;
                    const lowerContent = originalContent.toLowerCase();
                    
                    if (lowerContent.includes(searchTerm)) {
                        const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
                        cell.innerHTML = originalContent.replace(
                            regex, 
                            '<mark class="highlight">$1</mark>'
                        );
                    } else {
                        cell.textContent = originalContent;
                    }
                });
            });
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function renderDuplicatesTable(selectedCol) {
            const container = document.getElementById('duplicatesTableDiv');
            let html = '';
            
            if (selectedCol === '_ALL_') {
                let hasDuplicates = false;
                
                for (const col of columns) {
                    if (allDuplicates[col] && allDuplicates[col].length > 0) {
                        hasDuplicates = true;
                        html += `<h6>${col}</h6>`;
                        html += `<div class="table-responsive mb-3"><table class="table table-bordered table-sm table-striped"><thead><tr><th>Valor</th><th>Ocorrências</th></tr></thead><tbody>`;
                        
                        allDuplicates[col].forEach(([value, count]) => {
                            html += `<tr><td>${value}</td><td>${count}</td></tr>`;
                        });
                        
                        html += `</tbody></table></div>`;
                    }
                }
                
                if (!hasDuplicates) {
                    html = '<div class="alert alert-success py-2">Nenhum valor duplicado encontrado</div>';
                }
            } else {
                if (allDuplicates[selectedCol] && allDuplicates[selectedCol].length > 0) {
                    html += `<div class="table-responsive"><table class="table table-bordered table-sm table-striped"><thead><tr><th>Valor</th><th>Ocorrências</th></tr></thead><tbody>`;
                    
                    allDuplicates[selectedCol].forEach(([value, count]) => {
                        html += `<tr><td>${value}</td><td>${count}</td></tr>`;
                    });
                    
                    html += `</tbody></table></div>`;
                } else {
                    html = `<div class="alert alert-success py-2">Nenhum valor duplicado encontrado na coluna ${selectedCol}</div>`;
                }
            }
            
            container.innerHTML = html;
        }

        function generatePivotTable() {
            const rowField = document.getElementById('pivotRowSelect').value;
            const colField = document.getElementById('pivotColSelect').value || null;
            const valueField = document.getElementById('pivotValueSelect').value;
            const aggFunc = document.getElementById('pivotAggSelect').value;
            
            if (!rowField || !valueField) {
                alert('Selecione pelo menos uma coluna para Linhas e Valores.');
                return;
            }
            
            try {
                // Criar estrutura para pivot
                const pivotData = {};
                
                allData.forEach(row => {
                    const rowKey = row[rowField] !== undefined ? String(row[rowField]) : '';
                    const colKey = colField && row[colField] !== undefined ? String(row[colField]) : '';
                    const value = parseFloat(row[valueField]) || 0;
                    
                    if (!pivotData[rowKey]) {
                        pivotData[rowKey] = {};
                    }
                    
                    if (colField && !pivotData[rowKey][colKey]) {
                        pivotData[rowKey][colKey] = {
                            values: [],
                            count: 0,
                            sum: 0,
                            min: Infinity,
                            max: -Infinity
                        };
                    } else if (!colField && !pivotData[rowKey].total) {
                        pivotData[rowKey].total = {
                            values: [],
                            count: 0,
                            sum: 0,
                            min: Infinity,
                            max: -Infinity
                        };
                    }
                    
                    const cell = colField ? 
                        pivotData[rowKey][colKey] : 
                        pivotData[rowKey].total;
                        
                    cell.values.push(value);
                    cell.count++;
                    cell.sum += value;
                    cell.min = Math.min(cell.min, value);
                    cell.max = Math.max(cell.max, value);
                });
                
                // Calcular valores agregados
                const pivotRows = Object.keys(pivotData).sort();
                const pivotCols = colField ? 
                    Array.from(new Set(allData.map(row => row[colField]).filter(v => v !== undefined))).sort() : 
                    ['Total'];
                
                // Gerar cabeçalho da tabela
                const pivotHeader = document.getElementById('pivotHeader');
                pivotHeader.innerHTML = '';
                
                const headerRow = document.createElement('tr');
                const emptyHeader = document.createElement('th');
                emptyHeader.textContent = `${rowField} \\ ${colField || ''}`;
                headerRow.appendChild(emptyHeader);
                
                pivotCols.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                pivotHeader.appendChild(headerRow);
                
                // Gerar corpo da tabela
                const pivotBody = document.getElementById('pivotBody');
                pivotBody.innerHTML = '';
                
                pivotRows.forEach(rowKey => {
                    const tr = document.createElement('tr');
                    const rowHeader = document.createElement('th');
                    rowHeader.textContent = rowKey;
                    tr.appendChild(rowHeader);
                    
                    pivotCols.forEach(col => {
                        const cellData = pivotData[rowKey][col] || pivotData[rowKey].total;
                        if (!cellData) {
                            tr.appendChild(document.createElement('td'));
                            return;
                        }
                        
                        const td = document.createElement('td');
                        let result;
                        
                        switch (aggFunc) {
                            case 'sum': result = cellData.sum; break;
                            case 'mean': result = cellData.sum / cellData.count; break;
                            case 'count': result = cellData.count; break;
                            case 'max': result = cellData.max; break;
                            case 'min': result = cellData.min; break;
                            default: result = cellData.sum;
                        }
                        
                        // Formatar números
                        if (typeof result === 'number') {
                            td.textContent = Number.isInteger(result) ? 
                                result : 
                                result.toFixed(2);
                        } else {
                            td.textContent = result;
                        }
                        
                        tr.appendChild(td);
                    });
                    
                    pivotBody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Erro ao gerar tabela dinâmica:', error);
                alert('Ocorreu um erro ao gerar a tabela dinâmica. Verifique o console para detalhes.');
            }
        }

        // Função para gerar ícone baseado no tipo de dado
        function getIconForDataType(dataType) {
            switch(dataType) {
                case 'Numérico': return '<i class="fas fa-calculator"></i>';
                case 'Data': return '<i class="fas fa-calendar-alt"></i>';
                case 'Moeda': return '<i class="fas fa-money-bill-wave"></i>';
                default: return '<i class="fas fa-font"></i>';
            }
        }

        // Função refinada para detectar tipo de dado
        function detectDataType(value) {
            if (value === null || value === undefined) return 'Texto';
            
            // 1. Verificar se é número (tipo primitivo)
            if (typeof value === 'number') return 'Numérico';
            
            // 2. Verificar se é data (objeto Date)
            if (value instanceof Date) return 'Data';
            
            // Converter para string para análises subsequentes
            const strValue = String(value).trim();
            
            // 3. Verificar se é data (formato ISO)
            if (!isNaN(Date.parse(strValue)) && strValue.includes('-')) {
                return 'Data';
            }
            
            // 4. Verificar se é moeda (mais preciso)
            const currencyPatterns = [
                /^[R$]\s?\d{1,3}(\.\d{3})*,\d{2}$/, // R$ 1.000,00
                /^\d{1,3}(\.\d{3})*,\d{2}\s?[R$]?$/, // 1.000,00 R$
                /^USD\s?\d{1,3}(,\d{3})*\.\d{2}$/, // USD 1,000.00
                /^\d{1,3}(,\d{3})*\.\d{2}\s?USD$/ // 1,000.00 USD
            ];
            
            for (const regex of currencyPatterns) {
                if (regex.test(strValue)) {
                    return 'Moeda';
                }
            }
            
            // 5. Verificar se é número em string
            if (!isNaN(parseFloat(strValue)) && isFinite(strValue)) {
                return 'Numérico';
            }
            
            // 6. Verificar se é data (formatos comuns)
            const dateFormats = [
                /^\d{2}\/\d{2}\/\d{4}$/, // DD/MM/YYYY
                /^\d{4}-\d{2}-\d{2}$/,    // YYYY-MM-DD
                /^\d{2}-\d{2}-\d{4}$/     // DD-MM-YYYY
            ];
            
            for (const regex of dateFormats) {
                if (regex.test(strValue)) {
                    return 'Data';
                }
            }
            
            // 7. Padrão é texto
            return 'Texto';
        }

        // Função para gerar as barras de distribuição
        function generateDistributionBars(data, isNumeric) {
            if (data.length === 0) return '<div class="text-center py-4">Sem dados para exibir</div>';
            
            let barsHtml = '';
            const maxBars = 20;
            
            if (isNumeric) {
                // Converter para números e filtrar valores inválidos
                const numericData = data.map(v => parseFloat(v)).filter(v => !isNaN(v));
                if (numericData.length === 0) return '<div class="text-center py-4">Dados numéricos inválidos</div>';
                
                const min = Math.min(...numericData);
                const max = Math.max(...numericData);
                const range = max - min;
                
                if (range === 0) return '<div class="text-center py-4">Todos os valores são iguais</div>';
                
                const binSize = range / maxBars;
                const bins = Array(maxBars).fill(0);
                
                numericData.forEach(value => {
                    const binIndex = Math.min(Math.floor((value - min) / binSize), maxBars - 1);
                    bins[binIndex]++;
                });
                
                const maxCount = Math.max(...bins);
                
                bins.forEach((count, i) => {
                    if (count > 0) {
                        const height = Math.max(5, (count / maxCount) * 100);
                        const barWidth = 100 / maxBars - 0.5;
                        barsHtml += `
                            <div class="distribution-bar" 
                                 style="height: ${height}%; width: ${barWidth}%;"
                                 title="${(min + i * binSize).toFixed(2)} - ${(min + (i+1) * binSize).toFixed(2)}: ${count} valores">
                            </div>
                        `;
                    }
                });
            } else {
                // Distribuição para dados não numéricos
                const frequencyMap = {};
                data.forEach(val => {
                    const strVal = String(val);
                    frequencyMap[strVal] = (frequencyMap[strVal] || 0) + 1;
                });
                
                const sorted = Object.entries(frequencyMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, maxBars);
                
                if (sorted.length === 0) return '<div class="text-center py-4">Sem dados para exibir</div>';
                
                const maxCount = sorted[0][1];
                
                sorted.forEach(([value, count]) => {
                    const height = Math.max(5, (count / maxCount) * 100);
                    const barWidth = 100 / sorted.length - 0.5;
                    barsHtml += `
                        <div class="distribution-bar" 
                             style="height: ${height}%; width: ${barWidth}%;"
                             title="${value}: ${count} ocorrências">
                        </div>
                    `;
                });
            }
            
            return barsHtml || '<div class="text-center w-100 py-4">Dados insuficientes para exibir gráfico</div>';
        }

        function generateStats() {
            const container = document.getElementById('columnStatsAccordion');
            container.innerHTML = '';
            
            // Atualizar cards de resumo
            document.getElementById('statTotalRecords').textContent = allData.length;
            document.getElementById('statFilteredRecords').textContent = filteredData.length;
            document.getElementById('statTotalColumns').textContent = columns.length;
            
            // Calcular taxa de preenchimento
            let totalCells = allData.length * columns.length;
            let filledCells = 0;
            
            allData.forEach(row => {
                columns.forEach(col => {
                    if (row[col] !== undefined && row[col] !== null) {
                        filledCells++;
                    }
                });
            });
            
            const fillRate = totalCells > 0 ? Math.round((filledCells / totalCells) * 100) : 0;
            document.getElementById('statFillRate').textContent = fillRate + '%';
            
            if (allData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; color: #e0e0e0;"></i>
                        <p class="mt-3 small">Carregue um arquivo para visualizar estatísticas</p>
                    </div>
                `;
                return;
            }
            
            // GERAR ACORDEÃO PARA TODAS AS COLUNAS
            columns.forEach((col, index) => {
                const colData = allData.map(row => row[col]).filter(val => val !== undefined && val !== null);
                const nullCount = allData.length - colData.length;
                const uniqueValues = [...new Set(colData.map(v => String(v)))];
                const uniqueCount = uniqueValues.length;
                
                // Detectar tipo de dado com amostragem mais confiável
                let dataType = 'Texto';
                let isNumeric = false;
                let isCurrency = false;
                let isDate = false;
                
                if (colData.length > 0) {
                    // Analisar múltiplos valores para determinar tipo predominante
                    const typeCounts = {
                        'Numérico': 0,
                        'Moeda': 0,
                        'Data': 0,
                        'Texto': 0
                    };
                    
                    // Amostrar até 100 valores para classificação
                    const sampleSize = Math.min(colData.length, 100);
                    for (let i = 0; i < sampleSize; i++) {
                        const type = detectDataType(colData[i]);
                        typeCounts[type]++;
                    }
                    
                    // Determinar tipo predominante
                    let maxCount = 0;
                    for (const [type, count] of Object.entries(typeCounts)) {
                        if (count > maxCount) {
                            dataType = type;
                            maxCount = count;
                        }
                    }
                    
                    // Configurar flags
                    isNumeric = dataType === 'Numérico';
                    isCurrency = dataType === 'Moeda';
                    isDate = dataType === 'Data';
                }
                
                // Gerar estatísticas básicas para qualquer tipo de dado
                let statsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm stats-table">
                                <tr>
                                    <td class="stat-label">Tipo de Dado:</td>
                                    <td><span class="badge badge-${dataType.toLowerCase()}">${dataType}</span></td>
                                </tr>
                                <tr>
                                    <td class="stat-label">Valores não nulos:</td>
                                    <td>${colData.length} (${Math.round((colData.length/allData.length)*100)}%)</td>
                                </tr>
                                <tr>
                                    <td class="stat-label">Valores nulos:</td>
                                    <td>${nullCount} (${Math.round((nullCount/allData.length)*100)}%)</td>
                                </tr>
                                <tr>
                                    <td class="stat-label">Valores únicos:</td>
                                    <td>${uniqueCount}</td>
                                </tr>
                                <tr>
                                    <td class="stat-label">Taxa de Unicidade:</td>
                                    <td>${Math.round((uniqueCount/colData.length)*100)}%</td>
                                </tr>
                            </table>
                        </div>
                `;
                
                // Adicionar estatísticas específicas por tipo
                if (isNumeric || isCurrency) {
                    const numericData = colData.map(v => parseFloat(v)).filter(v => !isNaN(v));
                    
                    if (numericData.length > 0) {
                        const min = Math.min(...numericData);
                        const max = Math.max(...numericData);
                        const sum = numericData.reduce((a, b) => a + b, 0);
                        const mean = sum / numericData.length;
                        
                        statsHtml += `
                            <div class="col-md-6">
                                <table class="table table-sm stats-table">
                                    <tr>
                                        <td class="stat-label">Mínimo:</td>
                                        <td>${isCurrency ? 'R$ ' + min.toFixed(2) : min.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="stat-label">Máximo:</td>
                                        <td>${isCurrency ? 'R$ ' + max.toFixed(2) : max.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="stat-label">Média:</td>
                                        <td>${isCurrency ? 'R$ ' + mean.toFixed(2) : mean.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="stat-label">Soma:</td>
                                        <td>${isCurrency ? 'R$ ' + sum.toFixed(2) : sum.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="stat-label">Intervalo:</td>
                                        <td>${(max - min).toFixed(2)}</td>
                                    </tr>
                                </table>
                            </div>
                        `;
                    }
                } else {
                    // Estatísticas para dados não numéricos
                    const frequencyMap = {};
                    colData.forEach(val => {
                        const strVal = String(val);
                        frequencyMap[strVal] = (frequencyMap[strVal] || 0) + 1;
                    });
                    
                    // Top 5 valores
                    const topValues = Object.entries(frequencyMap)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    statsHtml += `
                        <div class="col-md-6">
                            <h6>Valores Mais Frequentes:</h6>
                            <table class="table table-sm stats-table">
                                <thead>
                                    <tr>
                                        <th>Valor</th>
                                        <th>Frequência</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${topValues.map(([value, count]) => `
                                        <tr>
                                            <td>${value}</td>
                                            <td>${count}</td>
                                            <td>${Math.round((count/colData.length)*100)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                statsHtml += `</div>`; // Fechar a row
                
                // Adicionar visualização de distribuição para todos os tipos
                statsHtml += `
                    <div class="mt-4">
                        <h6>Distribuição de Valores</h6>
                        <div class="distribution-chart bg-light p-2 rounded">
                            <div class="d-flex h-100 align-items-end" style="height: 120px;">
                                ${generateDistributionBars(colData, isNumeric || isCurrency)}
                            </div>
                        </div>
                    </div>
                `;
                
                // Classes para badges
                const badgeClass = {
                    'Numérico': 'badge-numeric',
                    'Moeda': 'badge-currency',
                    'Data': 'badge-date',
                    'Texto': 'badge-text'
                }[dataType] || 'badge-secondary';
                
                // Gerar acordeão para a coluna
                const accordionItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                                <div class="d-flex align-items-center w-100">
                                    <span class="accordion-icon">
                                        ${getIconForDataType(dataType)}
                                    </span>
                                    <div class="flex-grow-1">
                                        ${col}
                                        <span class="badge ${badgeClass}">${dataType}</span>
                                    </div>
                                    <div class="text-muted small me-2">
                                        ${uniqueCount} valores únicos
                                    </div>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse" 
                             aria-labelledby="heading${index}" data-bs-parent="#columnStatsAccordion">
                            <div class="accordion-body">
                                ${statsHtml}
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += accordionItem;
            });
            
            // Adicionar funcionalidade aos botões de expandir/recolher
            document.getElementById('expandAllStats').addEventListener('click', function() {
                const collapses = document.querySelectorAll('#columnStatsAccordion .accordion-collapse');
                collapses.forEach(collapse => {
                    new bootstrap.Collapse(collapse, { show: true });
                });
            });

            document.getElementById('collapseAllStats').addEventListener('click', function() {
                const collapses = document.querySelectorAll('#columnStatsAccordion .accordion-collapse.show');
                collapses.forEach(collapse => {
                    new bootstrap.Collapse(collapse, { hide: true });
                });
            });
        }

        // Funções de exportação
        function exportToCsv() {
            if (filteredData.length === 0) {
                alert('Não há dados para exportar');
                return;
            }
            
            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `dados_filtrados_${new Date().toISOString().slice(0,10)}.csv`);
        }

        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('Não há dados para exportar');
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(filteredData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Dados Filtrados");
            XLSX.writeFile(workbook, `dados_filtrados_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportPivotToCsv() {
            const pivotTable = document.getElementById('pivotTable');
            if (!pivotTable || pivotTable.rows.length < 2) {
                alert('Gere uma tabela dinâmica primeiro');
                return;
            }
            
            let csv = '';
            for (let i = 0; i < pivotTable.rows.length; i++) {
                const row = pivotTable.rows[i];
                let rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    rowData.push(`"${row.cells[j].textContent}"`);
                }
                csv += rowData.join(',') + '\n';
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `tabela_dinamica_${new Date().toISOString().slice(0,10)}.csv`);
        }

        function exportPivotToExcel() {
            const pivotTable = document.getElementById('pivotTable');
            if (!pivotTable || pivotTable.rows.length < 2) {
                alert('Gere uma tabela dinâmica primeiro');
                return;
            }
            
            const data = [];
            for (let i = 0; i < pivotTable.rows.length; i++) {
                const row = pivotTable.rows[i];
                let rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    rowData.push(row.cells[j].textContent);
                }
                data.push(rowData);
            }
            
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Tabela Dinâmica");
            XLSX.writeFile(workbook, `tabela_dinamica_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportDuplicates() {
            const selectedCol = document.getElementById('dupColSelect').value;
            let dataToExport = [];
            
            if (selectedCol === '_ALL_') {
                for (const col of columns) {
                    if (allDuplicates[col]) {
                        allDuplicates[col].forEach(([value, count]) => {
                            dataToExport.push({
                                Coluna: col,
                                Valor: value,
                                Ocorrências: count
                            });
                        });
                    }
                }
            } else {
                if (allDuplicates[selectedCol]) {
                    allDuplicates[selectedCol].forEach(([value, count]) => {
                        dataToExport.push({
                            Coluna: selectedCol,
                            Valor: value,
                            Ocorrências: count
                        });
                    });
                }
            }
            
            if (dataToExport.length === 0) {
                alert('Não há dados duplicados para exportar');
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Duplicados");
            XLSX.writeFile(workbook, `duplicados_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            updateFreezeSettings();
            updatePivotFreezeSettings();
        });
    </script>
</body>
</html>
